---
import Base from '../../layouts/Base.astro';
---

<Base title="Send Newsletter - Admin">
	<style>
		.admin-container {
			max-width: 600px;
			margin: 2rem auto;
			padding: 0 1rem;
		}

		h1 {
			font-size: 1.5rem;
			font-weight: 600;
			margin-bottom: 2rem;
		}

		.form-group {
			margin-bottom: 1.5rem;
		}

		label {
			display: block;
			font-weight: 500;
			margin-bottom: 0.5rem;
		}

		input, textarea {
			width: 100%;
			padding: 0.75rem;
			border: 1px solid #e5e5e5;
			border-radius: 4px;
			font-family: inherit;
			font-size: 0.95rem;
		}

		input:focus, textarea:focus {
			outline: none;
			border-color: #999;
		}

		textarea {
			min-height: 200px;
			resize: vertical;
		}

		.btn-send {
			background: #000;
			color: #fff;
			border: none;
			padding: 0.75rem 1.5rem;
			border-radius: 4px;
			font-family: inherit;
			font-size: 0.95rem;
			cursor: pointer;
		}

		.btn-send:hover {
			background: #333;
		}

		.btn-send:disabled {
			background: #999;
			cursor: not-allowed;
		}

		.status {
			margin-top: 1rem;
			padding: 1rem;
			border-radius: 4px;
			display: none;
		}

		.status.success {
			display: block;
			background: #e8f5e9;
			color: #2e7d32;
		}

		.status.error {
			display: block;
			background: #ffebee;
			color: #c62828;
		}

		.hint {
			font-size: 0.85rem;
			color: #666;
			margin-top: 0.25rem;
		}
	</style>

	<div class="admin-container">
		<h1>Send Newsletter</h1>

		<form id="newsletter-form">
			<div class="form-group">
				<label for="secret">Secret Key</label>
				<input type="password" id="secret" name="secret" required />
			</div>

			<div class="form-group">
				<label for="subject">Subject</label>
				<input type="text" id="subject" name="subject" required />
			</div>

			<div class="form-group">
				<label for="html">Message (HTML)</label>
				<textarea id="html" name="html" required placeholder="<p>Your message here...</p>"></textarea>
				<p class="hint">Use HTML tags for formatting</p>
			</div>

			<button type="submit" class="btn-send">Send Newsletter</button>
		</form>

		<div class="status" id="status"></div>
	</div>

	<script>
		document.getElementById('newsletter-form')?.addEventListener('submit', async (e) => {
			e.preventDefault();
			const form = e.target;
			const btn = form.querySelector('button');
			const status = document.getElementById('status');

			const secret = form.secret.value;
			const subject = form.subject.value;
			const html = form.html.value;

			btn.disabled = true;
			btn.textContent = 'Sending...';
			status.className = 'status';
			status.textContent = '';

			try {
				const res = await fetch('/api/send-newsletter', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'x-api-key': secret
					},
					body: JSON.stringify({ subject, html })
				});

				const data = await res.json();

				if (res.ok) {
					status.textContent = data.count ? `${data.message}! Sent to ${data.count} subscriber(s).` : data.message;
					status.className = 'status success';
					form.subject.value = '';
					form.html.value = '';
				} else {
					status.textContent = data.error || 'Failed to send';
					status.className = 'status error';
				}
			} catch {
				status.textContent = 'Network error. Please try again.';
				status.className = 'status error';
			}

			btn.disabled = false;
			btn.textContent = 'Send Newsletter';
		});
	</script>
</Base>
